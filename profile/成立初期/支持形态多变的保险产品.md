# 支持形态多变的保险产品<!-- omit in toc -->

[投保逻辑](https://github.com/fooins/insbiz/blob/main/src/components/policies/services/accept/index.js) | [业务规则组件](https://github.com/fooins/insbiz/blob/main/src/libraries/biz-config/index.js) | [默认计费公式](https://github.com/fooins/insbiz/blob/main/src/libraries/formulas/default.js)

保司在展业过程中，会不断推出新的保险产品来适应市场的快速变化和应对不同的业务场景。不同产品之间的差异点主要体现在业务规则、数据收集以及计费逻辑等方面。例如：

- 业务规则差异：有些产品要求起保时间必须从第二天零时开始，而有些产品则允许立即生效。
- 数据收集差异：退货运费险要求必须保存对应的物流单号，而其他保险产品则不需要。
- 计费逻辑差异：账户安全险基本可以统一保费，而退货运费险则跟买卖方的历史赔付记录相关。

因此，要求保险业务系统需要足够的灵活，才能支持多变的产品形态，当然也不能以牺牲系统的可维护性和可持续发展作为代价。比如：对每个保险产品都进行定制化开发，这固然是最灵活的，但其开发效率会大大降低，后续也将难以统一维护和迭代，显然并不可取。

以下针对业务规则差异、数据收集差异和计费逻辑差异三个方面给出具体的系统实施思路。

## 1. 业务规则差异

按照功能（比如承保、批改等）的维度，定义统一的、缺省的业务规则配置，这些配置是从业务角度进行定义的，不依赖于具体的技术。

允许在保险产品、产品计划、销售渠道或契约等实体中进行业务规则配置，系统运行时会按照 “缺省 < 产品 < 计划 < 渠道 < 契约” 的优先级叠加合并配置信息，然后根据配置的含义执行相应的处理逻辑。

兜底机制：支持在业务规则配置中设置定制化的规则处理程序，系统执行处理逻辑之前会先调用该程序，程序中可以改变特定的上下文信息来影响后续的处理逻辑，以达到个性化需求的目的。

## 2. 数据收集差异

通过上述的业务规则配置机制，可以灵活配置所需的数据，符合要求的最终都将会被保存。比如：对于退货运费险产品，可以设置开启 “物流单号” 功能，而对于账户安全险产品，则设置开启 “用户账户名称” 功能。

这些与特定产品相关的字段，它们对于不相关的产品来说都是不必要的，因此可以称之为 “扩展字段”。而且，这些扩展字段可能会随着新业务的接入不断增加，所以，它们很适合以 JSON 的格式保存在一个单独的字段中（MySQL）。

通常情况下，这些扩展字段并不需要作为搜索条件，如有必要，也可使用 MySQL JSON 相关的函数进行搜索，也可以将数据同步到 elastic search 中进行搜索。

使用 JSON 格式存储扩展字段有一个弊端，就是管理不规范的话，可能会导致 “同类数据保存为多个不同字段” 或 “不同类型的数据保存到同名的字段” 等问题。所以，需要对所有的扩展字段进行严格统一的管理。

兜底机制：支持在业务规则配置中设置定制化的数据入库前置处理程序，系统执行数据入库之前会先调用该程序，程序中可以对入库前的数据进行个性化的处理。

## 3. 计费逻辑差异

单独为每种计费算法开发脚本，并支持在业务规则配置中指定。计费算法中所需的各类常量也都支持在业务规则配置中设置，计费因子（变量）则由系统根据实际数据计算得出。

通常情况下，一个计费脚本可以设计为支持大多数所需的常量和计费因子，所以，理论上并不会存在大量计费脚本的情况。
